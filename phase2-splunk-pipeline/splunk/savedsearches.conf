# Splunk Saved Searches – Phase 2 Security Automation Pipeline
# ============================================================
# Deploy by copying this file to:
#   $SPLUNK_HOME/etc/apps/<your_app>/local/savedsearches.conf
#
# Or import via Splunk Web: Settings → Searches, reports, and alerts → New.
#
# Threshold rationale is documented inline for each search.

[default]
dispatch.earliest_time = -15m
dispatch.latest_time    = now
cron_schedule           = */5 * * * *
is_scheduled            = 1
alert_type              = number of events
alert_comparator        = greater than
alert_threshold         = 0


# ──────────────────────────────────────────────────────────────────────────────
# 1. Brute Force SSH – 5+ Failures in 60 s
# Threshold: 5 failures/minute from a single src_ip catches genuine brute-force
# while keeping false-positive rates low for misconfigured clients that may
# retry 1–2 times.  At 20+/min we escalate to "critical" for immediate SOC
# triage; 10–19 is "high"; 5–9 is "medium".
# ──────────────────────────────────────────────────────────────────────────────
[Brute Force SSH - 5+ Failures in 60s]
search = index=security_events sourcetype="syslog:ssh" event_type="ssh_failed_login" \
    | bucket _time span=60s \
    | stats count by _time, src_ip, dst_ip \
    | where count >= 5 \
    | eval severity=if(count>=20,"critical",if(count>=10,"high","medium")) \
    | table _time, src_ip, dst_ip, count, severity
description = Detect SSH brute-force attempts: 5 or more failed logins from the \
    same source IP within a 60-second window.  Escalates to critical at 20+ failures.
alert.severity = 3
alert_condition = search count > 0


# ──────────────────────────────────────────────────────────────────────────────
# 2. Rare Process Execution – Statistical Outliers
# Uses the `rare` command to surface process/host combinations seen in fewer
# than 1 % of hosts over the last hour.  Low absolute count (≤ 3) further
# filters noise from legitimate admin activity.
# ──────────────────────────────────────────────────────────────────────────────
[Rare Process Execution - Statistical Outlier]
search = index=security_events sourcetype="syslog:process" event_type="suspicious_process" \
    | stats dc(hostname) as host_count, values(command_line) as cmds by process_name \
    | where host_count <= 3 \
    | eval rarity_pct=round(host_count / 100 * 100, 2) \
    | sort + host_count \
    | head 20 \
    | table process_name, host_count, rarity_pct, cmds
description = Identify process names executed on very few hosts (≤ 3), indicating \
    potential living-off-the-land or novel malware not yet widespread.
alert.severity = 2
dispatch.earliest_time = -1h


# ──────────────────────────────────────────────────────────────────────────────
# 3. C2 Beacon Behaviour – Low Coefficient of Variation
# Beaconing is characterised by highly regular inter-connection intervals.
# A coefficient of variation (CV = stdev/mean) below 0.3 indicates mechanical
# regularity unlikely to arise from human browsing.  We require at least 5
# connections to the same dst_ip to avoid false positives from scheduled
# system tasks.
# ──────────────────────────────────────────────────────────────────────────────
[C2 Beaconing - Regular Interval Outbound Connections]
search = index=security_events sourcetype="network:flow" event_type="suspicious_outbound" \
    | sort src_ip, dst_ip, _time \
    | streamstats current=f last(_time) as prev_time by src_ip, dst_ip \
    | eval interval_sec=_time - prev_time \
    | where interval_sec > 0 \
    | stats count, avg(interval_sec) as mean_interval, stdev(interval_sec) as sd_interval \
        by src_ip, dst_ip, dst_port \
    | where count >= 5 \
    | eval cv=round(sd_interval / mean_interval, 3) \
    | where cv < 0.3 \
    | eval severity=if(dst_port IN (4444, 1337, 31337, 9001), "critical", "high") \
    | table src_ip, dst_ip, dst_port, count, mean_interval, cv, severity \
    | sort + cv
description = Identify hosts making regularly-timed outbound connections (CV < 0.3) \
    to the same destination IP – a hallmark of C2 beacon implants.
alert.severity = 3
dispatch.earliest_time = -30m


# ──────────────────────────────────────────────────────────────────────────────
# 4. Phase 1 Normalizer IOC Match – Malicious Verdict
# Correlates Phase 2 endpoint telemetry with Phase 1 threat-intel verdicts.
# Fires when a hash flagged as "malicious" by the normalizer is observed on
# any endpoint.  Scoped to the threat_intel index where the bridge writes.
# ──────────────────────────────────────────────────────────────────────────────
[Phase 1 Normalizer - Malicious IOC Detected]
search = index=threat_intel sourcetype="threat:normalizer" is_malicious=true \
    | eval indicator=coalesce(indicator_value, "unknown") \
    | stats count, values(hostname) as affected_hosts, \
            max(threat_score) as max_score \
        by indicator, verdict, indicator_type, indicator_family \
    | where count >= 1 \
    | eval severity=case( \
        max_score>=75, "critical", \
        max_score>=50, "high", \
        max_score>=25, "medium", \
        1==1, "low") \
    | sort - max_score \
    | table indicator, indicator_type, verdict, max_score, severity, count, affected_hosts
description = Alert when Phase 1 normalizer reports a malicious IOC verdict for \
    any indicator enriched with threat-intel from VirusTotal or AbuseIPDB.
alert.severity = 3
dispatch.earliest_time = -1h


# ──────────────────────────────────────────────────────────────────────────────
# 5. Suspicious DNS Queries – DGA or Tunnel Detection
# Flags DNS queries that appear algorithmically generated (random-looking
# hostnames) or exhibit the long-subdomain pattern typical of DNS tunnelling.
# ──────────────────────────────────────────────────────────────────────────────
[Suspicious DNS - DGA or Tunnel Query]
search = index=security_events sourcetype="network:dns" event_type="suspicious_dns" \
    | eval query_len=len(query) \
    | eval label=case( \
        is_tunnel=true, "dns_tunnel", \
        is_dga=true,    "dga", \
        query_len>50,   "long_query", \
        1==1,           "suspicious") \
    | stats count by src_ip, query, label \
    | where count >= 1 \
    | sort - count \
    | table src_ip, query, label, count
description = Surface DNS queries matching DGA patterns or unusually long \
    subdomain labels that may indicate DNS-over-DNS tunnelling for C2 or exfiltration.
alert.severity = 2
dispatch.earliest_time = -15m


# ──────────────────────────────────────────────────────────────────────────────
# 6. Critical File-Hash IOC Match on Endpoint
# ──────────────────────────────────────────────────────────────────────────────
[Endpoint IOC - Critical File Hash Match]
search = index=security_events sourcetype="endpoint:ioc" event_type="ioc_file_match" \
    severity=critical \
    | stats count, values(file_path) as paths, values(threat_name) as threats \
        by hostname, sha256 \
    | table hostname, sha256, threats, paths, count
description = Alert when an endpoint AV/EDR reports a critical-severity file-hash \
    match against known malware (e.g. Mimikatz, Cobalt Strike, ransomware droppers).
alert.severity = 3
dispatch.earliest_time = -30m
